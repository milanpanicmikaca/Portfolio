-- upload to BQ
with timeseries as 
    (
    select 
    date_trunc(date_array,{period}) as date,
    from unnest(generate_date_array('2018-04-16',current_date(), interval 1 day)) as date_array
    group by 1
    ),
final_closes as (
    select 
        date_trunc(won_at,{period}) as close_date,
        market,
        --regexp_extract(ou.geo,'/.*/(.*)/') as market,
        market_id,
        region,
        old_region,
        case when ou.product like '/Fence Installation/%' then 1 else 0 end as is_fence,
        case when ou.product like '/Driveway Installation/%' then 1 else 0 end as is_driveway,
        case when ou.product like '/Landscaping/%' then 1 else 0 end as is_turf,
        case when ou.type = '/Commercial' then 1 else 0 end as is_commercial,
        sum(case when channel like '%Home Advisor%' and channel not like '%Home Advisor/Ads' then 1 else 0 end) as ha_closes,
        sum(case when channel like '%Home Advisor/Ads' then 1 else 0 end) as ha_ads_closes,
        sum(case when channel like '%Thumbtack%' then 1 else 0 end) as tt_closes,
        sum(case when channel like '%/Paid/Facebook%' then 1 else 0 end) as fb_closes, -- as FB has also Non Paid leads, select only Paid FB
        sum(case when channel like '%/Paid/Google%' then 1 else 0 end) as gg_closes, -- as Google has also Non Paid leads, select only Paid Google
        sum(case when channel like '%Nextdoor%' then 1 else 0 end) as nd_closes, --corrected 18/08/2022
        sum(case when channel like '%Bark%' then 1 else 0 end) as ba_closes, --added 18/08/2022
        sum(case when channel like '%Borg%' then 1 else 0 end) as bo_closes,
        sum(case when channel like '%Misc%' then 1 else 0 end) as ms_closes,
        sum(case when channel like '%Yelp%' then 1 else 0 end) as yp_closes,
        sum (case when channel like '%/Paid/%' then 1 else 0 end) as total_closes --it's better to have all paid closes by channel Paid rather than naming every channel
    from int_data.order_ue_materialized ou
    group by 1, 2, 3, 4, 5, 6, 7,8,9
    ),

spend as (
select 
    date_trunc(created_at, {period}) as lead_arrived_at,
    market,
    --regexp_extract(ou.geo,'/.*/(.*)/') as market,
    market_id,
    region,
    old_region,
    case when ou.product like '/Fence Installation/%' then 1 else 0 end as is_fence,
    case when ou.product like '/Driveway Installation/%' then 1 else 0 end as is_driveway,
    case when ou.product like '/Landscaping/%' then 1 else 0 end as is_turf,
    case when ou.type = '/Commercial' then 1 else 0 end as is_commercial,
    sum(ha_fee) as ha_fee,
    sum(ha_ads_fee) as ha_ads_fee,
    sum(tt_fee) as tt_fee,
    sum(fb_fee) as fb_fee,
    sum(gg_fee + gg_gls_fee) as gg_fee, --added gls fee
    sum(nd_fee) as nd_fee, --added 18/08/2022
    sum(ba_fee) as ba_fee, --added 18/08/2022
    sum(sdr_fee) as ms_fee, --currently SDR is misc channel
    sum(yelp_cpl_budget) as yp_fee,
    sum(bo_fee) as bo_fee,
    sum(mktg_fee) as total_fee
 from int_data.order_ue_materialized ou
 group by 1, 2, 3, 4, 5, 6, 7,8,9
    ),
cpa as(
select 
    t.date as date,
    coalesce(sum(case when s.old_region = 'North California'  and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then total_closes end),0),0) as SAL471D, -- cpa_nc,
    coalesce(sum(case when s.old_region = 'North California'  and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.old_region = 'North California' and c.is_commercial = 1 then total_closes end),0),0) as SAL471C, -- cpa_nc,
    coalesce(sum(case when s.old_region = 'South California'  and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_driveway = 1 then total_closes end),0),0) as SAL375D, -- cpa_sc,
    coalesce(sum(case when s.old_region = 'South California'  and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_commercial = 1 then total_closes end),0),0) as SAL375C, -- cpa_sc,

    coalesce(sum(case when s.market like '%-TX-%' and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_driveway = 1 then total_closes end),0),0) as SAL592D, -- cpa_tx,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL592C, -- cpa_tx,

    coalesce(sum(case when s.market_id = 3 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 3 and c.is_driveway = 1 then total_closes end),0),0) as SAL241D, -- cpa_sac,
    coalesce(sum(case when s.market_id = 3 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 3 and c.is_commercial = 1 then total_closes end),0),0) as SAL241C, -- cpa_sac,

    coalesce(sum(case when s.market_id = 2 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 2 and c.is_driveway = 1 then total_closes end),0),0) as SAL240D, -- cpa_eb,
    coalesce(sum(case when s.market_id = 2 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 2 and c.is_commercial = 1 then total_closes end),0),0) as SAL240C, -- cpa_eb,

    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then total_closes end),0),0) as SAL243F, -- cpa_nb,
    coalesce(sum(case when s.market_id = 9 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 9 and c.is_driveway = 1 then total_closes end),0),0) as SAL243D, -- cpa_nb,
    coalesce(sum(case when s.market_id = 9 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 9 and c.is_commercial = 1 then total_closes end),0),0) as SAL243C, -- cpa_nb,

    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id in (4,30,31) and c.is_fence = 1 then total_closes end),0),0) as SAL242F, -- cpa_sb,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id in (4,30,31) and c.is_driveway = 1 then total_closes end),0),0) as SAL242D, -- cpa_sb,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id in (4,30,31) and c.is_commercial = 1 then total_closes end),0),0) as SAL242C, -- cpa_sb,

    coalesce(sum(case when s.market_id = 10 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 10 and c.is_driveway = 1 then total_closes end),0),0) as SAL245D, -- cpa_fr,
    coalesce(sum(case when s.market_id = 10 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 10 and c.is_commercial = 1 then total_closes end),0),0) as SAL245C, -- cpa_fr,

    coalesce(sum(case when s.market_id = 5 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 5 and c.is_driveway = 1 then total_closes end),0),0) as SAL436D, -- cpa_oc,_id
    coalesce(sum(case when s.market_id = 5 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 5 and c.is_commercial = 1 then total_closes end),0),0) as SAL436C, -- cpa_oc,_id
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then total_closes end),0),0) as SAL436F, -- cpa_oc,
    coalesce(sum(case when s.market_id = 5 and s.is_turf = 1 then total_fee end) / nullif(sum(case when c.market_id = 5 and c.is_turf = 1 then total_closes end),0),0) as SAL436T, -- cpa_oc,

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then total_closes end),0),0) as SAL429D, -- cpa__idsv,
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then total_closes end),0),0) as SAL429C, -- cpa__idsv,

    coalesce(sum(case when s.market_id = 6 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 6 and c.is_driveway = 1 then total_closes end),0),0) as SAL443D, -- cpa__idla,
    coalesce(sum(case when s.market_id = 6 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 6 and c.is_commercial = 1 then total_closes end),0),0) as SAL443C, -- cpa__idla,

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then total_closes end),0),0) as SAL528D, -- cpa__idvc,
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then total_closes end),0),0) as SAL528C, -- cpa__idvc,

    coalesce(sum(case when s.market_id = 1 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 1 and c.is_driveway = 1 then total_closes end),0),0) as SAL585D, -- cpa__idsd,
    coalesce(sum(case when s.market_id = 1 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 1 and c.is_commercial = 1 then total_closes end),0),0) as SAL585C, -- cpa__idsd,

    coalesce(sum(case when s.market_id = 16 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 16 and c.is_driveway = 1 then total_closes end),0),0) as SAL593D, -- cpa_dl,
    coalesce(sum(case when s.market_id = 16 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 16 and c.is_commercial = 1 then total_closes end),0),0) as SAL593C, -- cpa_dl,

    coalesce(sum(case when s.market_id = 17 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 17 and c.is_driveway = 1 then total_closes end),0),0) as SAL594D, -- cpa_fw,
    coalesce(sum(case when s.market_id = 17 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 17 and c.is_commercial = 1 then total_closes end),0),0) as SAL594C, -- cpa_fw,
    
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then total_closes end),0),0) as SAL671F,
    coalesce(sum(case when s.market_id = 4 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 4 and c.is_driveway = 1 then total_closes end),0),0) as SAL671D, 
    coalesce(sum(case when s.market_id = 4 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 4 and c.is_commercial = 1 then total_closes end),0),0) as SAL671C, 

    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then total_closes end),0),0) as SAL672F, 
    coalesce(sum(case when s.market_id = 30 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 30 and c.is_driveway = 1 then total_closes end),0),0) as SAL672D, 
    coalesce(sum(case when s.market_id = 30 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 30 and c.is_commercial = 1 then total_closes end),0),0) as SAL672C, 

    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then total_closes end),0),0) as SAL673F, 
    coalesce(sum(case when s.market_id = 31 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 31 and c.is_driveway = 1 then total_closes end),0),0) as SAL673D, 
    coalesce(sum(case when s.market_id = 31 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 31 and c.is_commercial = 1 then total_closes end),0),0) as SAL673C, 

    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then total_closes end),0),0) as SAL674F, 
    coalesce(sum(case when s.market_id = 29 and s.is_driveway = 1 then total_fee end) / nullif(sum(case when c.market_id = 29 and c.is_driveway = 1 then total_closes end),0),0) as SAL674D,
    coalesce(sum(case when s.market_id = 29 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 29 and c.is_commercial = 1 then total_closes end),0),0) as SAL674C, 
    coalesce(sum(case when s.market like '%-VA-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like '%-VA-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL877C, -- cpa_va,
    coalesce(sum(case when s.market_id = 35 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 35 and c.is_commercial = 1 then total_closes end),0),0) as SAL857C, -- cpa_ar,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like '%-FL-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL898C, -- cpa_fl,
    coalesce(sum(case when s.market_id = 24 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 24 and c.is_commercial = 1 then total_closes end),0),0) as SAL919C, -- cpa_mi,
    coalesce(sum(case when s.market_id = 26 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 26 and c.is_commercial = 1 then total_closes end),0),0) as SAL939C, -- cpa_or,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like '%-MD-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL773C, -- cpa_md,

    coalesce(sum(case when s.market_id = 22 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 22 and c.is_commercial = 1 then total_closes end),0),0) as SAL733C, -- cpa_bl,
    coalesce(sum(case when s.market_id = 21 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 21 and c.is_commercial = 1 then total_closes end),0),0) as SAL753C, -- cpa_dc,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like '%-PA-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL814C, -- cpa_pa,
    coalesce(sum(case when s.market_id = 33 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 33 and c.is_commercial = 1 then total_closes end),0),0) as SAL794C, -- cpa_ph,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like '%-GA-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL837C, -- cpa_ga,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like 'PA-WA-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL1071C, -- cpa_pa_wa,
    coalesce(sum(case when s.market_id = 43 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 43 and c.is_commercial = 1 then total_closes end),0),0) as SAL1045C, -- cpa_se
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market like 'WN-IL-%' and c.is_commercial = 1 then total_closes end),0),0) as SAL1143C, -- cpa_wn_il,
    coalesce(sum(case when s.market_id = 42 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 42 and c.is_commercial = 1 then total_closes end),0),0) as SAL1166C, -- cpa_wn_il_ch,
    coalesce(sum(case when s.market_id = 57 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 57 and c.is_commercial = 1 then total_closes end),0),0) as SAL1189C, -- cpa_wn_il_na,
    coalesce(sum(case when s.market_id = 58 and s.is_commercial = 1 then total_fee end) / nullif(sum(case when c.market_id = 58 and c.is_commercial = 1 then total_closes end),0),0) as SAL1212C, -- cpa_wn_il_la,
    -----------HA------------

    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then ha_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then ha_closes end),0),0) as MAR659D,
    coalesce(sum(case when s.old_region = 'North California' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_commercial = 1 then ha_closes end),0),0) as MAR659C,

    coalesce(sum(case when s.old_region = 'South California' and s.is_driveway = 1 then ha_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_driveway = 1 then ha_closes end),0),0) as SAL376D, -- ha_cpa_sc,
    coalesce(sum(case when s.old_region = 'South California' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_commercial = 1 then ha_closes end),0),0) as SAL376C, -- ha_cpa_sc,

    coalesce(sum(case when s.market like '%-TX-%' and s.is_driveway = 1 then ha_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_driveway = 1 then ha_closes end),0),0) as SAL595D, -- ha_cpa_tx,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_commercial = 1 then ha_closes end),0),0) as SAL595C, -- ha_cpa_tx,

    coalesce(sum(case when s.market_id = 3 and s.is_driveway = 1 then ha_fee end)/nullif(sum(case when c.market_id = 3 and c.is_driveway = 1 then ha_closes end),0),0) as MAR442D, -- ha_cpa_sac,
    coalesce(sum(case when s.market_id = 3 and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market_id = 3 and c.is_commercial = 1 then ha_closes end),0),0) as MAR442C, -- ha_cpa_sac,

    coalesce(sum(case when s.market_id = 2 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 2 and c.is_driveway = 1 then ha_closes end),0),0) as MAR439D, -- ha_cpa_eb,
    coalesce(sum(case when s.market_id = 2 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 2 and c.is_commercial = 1 then ha_closes end),0),0) as MAR439C, -- ha_cpa_eb,

    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then ha_closes end),0),0) as MAR441F,
    coalesce(sum(case when s.market_id = 9 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 9 and c.is_driveway = 1 then ha_closes end),0),0) as MAR441D, 
    coalesce(sum(case when s.market_id = 9 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 9 and c.is_commercial = 1 then ha_closes end),0),0) as MAR441C, 

    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_driveway = 1 then ha_closes end),0),0) as MAR440D, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_commercial = 1 then ha_closes end),0),0) as MAR440C,

    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then ha_closes end),0),0) as MAR443F, 
    coalesce(sum(case when s.market_id = 10 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 10 and c.is_driveway = 1 then ha_closes end),0),0) as MAR443D, 
    coalesce(sum(case when s.market_id = 10 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 10 and c.is_commercial = 1 then ha_closes end),0),0) as MAR443C, 

    coalesce(sum(case when s.market_id = 5 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 5 and c.is_driveway = 1 then ha_closes end),0),0) as SAL437D, 
    coalesce(sum(case when s.market_id = 5 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 5 and c.is_commercial = 1 then ha_closes end),0),0) as SAL437C,

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then ha_closes end),0),0) as SAL430D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then ha_closes end),0),0) as SAL430C, 

    coalesce(sum(case when s.market_id = 6 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 6 and c.is_driveway = 1 then ha_closes end),0),0) as SAL444D, 
    coalesce(sum(case when s.market_id = 6 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 6 and c.is_commercial = 1 then ha_closes end),0),0) as SAL444C, 

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then ha_closes end),0),0) as SAL529D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then ha_closes end),0),0) as SAL529C, 

    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then ha_closes end),0),0) as SAL586F, 
    coalesce(sum(case when s.market_id = 1 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 1 and c.is_driveway = 1 then ha_closes end),0),0) as SAL586D, 
    coalesce(sum(case when s.market_id = 1 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 1 and c.is_commercial = 1 then ha_closes end),0),0) as SAL586C, 

    coalesce(sum(case when s.market_id = 16 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 16 and c.is_driveway = 1 then ha_closes end),0),0) as SAL596D, 
    coalesce(sum(case when s.market_id = 16 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 16 and c.is_commercial = 1 then ha_closes end),0),0) as SAL596C, 

    coalesce(sum(case when s.market_id = 17 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 17 and c.is_driveway = 1 then ha_closes end),0),0) as SAL597D, 
    coalesce(sum(case when s.market_id = 17 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 17 and c.is_commercial = 1 then ha_closes end),0),0) as SAL597C,    
    
    coalesce(sum(case when s.market_id = 4 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 4 and c.is_driveway = 1 then ha_closes end),0),0) as MAR888D, 
    coalesce(sum(case when s.market_id = 4 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 4 and c.is_commercial = 1 then ha_closes end),0),0) as MAR888C, 

    coalesce(sum(case when s.market_id = 30 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 30 and c.is_driveway = 1 then ha_closes end),0),0) as MAR889D, 
    coalesce(sum(case when s.market_id = 30 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 30 and c.is_commercial = 1 then ha_closes end),0),0) as MAR889C, 

    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then ha_closes end),0),0) as MAR890F, 
    coalesce(sum(case when s.market_id = 31 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 31 and c.is_driveway = 1 then ha_closes end),0),0) as MAR890D, 
    coalesce(sum(case when s.market_id = 31 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 31 and c.is_commercial = 1 then ha_closes end),0),0) as MAR890C, 

    coalesce(sum(case when s.market_id = 29 and s.is_driveway = 1 then ha_fee end) / nullif(sum(case when c.market_id = 29 and c.is_driveway = 1 then ha_closes end),0),0) as MAR891D, 
    coalesce(sum(case when s.market_id = 29 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 29 and c.is_commercial = 1 then ha_closes end),0),0) as MAR891C, 
    coalesce(sum(case when s.market like '%-VA-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR1555C,    
    coalesce(sum(case when s.market_id = 35 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 35 and c.is_commercial = 1 then ha_closes end),0),0) as MAR1525C, -- ha_cpa_ar,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR1599C,    
    coalesce(sum(case when s.market_id = 24 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 24 and c.is_commercial = 1 then ha_closes end),0),0) as MAR1635C, -- ha_cpa_mi,
    coalesce(sum(case when s.market_id = 26 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 26 and c.is_commercial = 1 then ha_closes end),0),0) as MAR1683C, -- ha_cpa_mi,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR1211C,

    coalesce(sum(case when s.market_id = 22 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 22 and c.is_commercial = 1 then ha_closes end),0),0) as MAR1142C, -- ha_cpa_bl,
    coalesce(sum(case when s.market_id = 21 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 21 and c.is_commercial = 1 then ha_closes end),0),0) as MAR1183C, -- ha_cpa_dc,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR1276C, --ha_cpa_pa
    coalesce(sum(case when s.market_id = 33 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 33 and c.is_commercial = 1 then ha_closes end),0),0) as MAR1246C, -- ha_cpa_ph,
    
    coalesce(sum(case when s.market like '%-GA-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR1313C,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR2293C, 
    coalesce(sum(case when s.market_id = 43 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 43 and c.is_commercial = 1 then ha_closes end),0),0) as MAR2251C, -- ha_cpa_se,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_commercial = 1 then ha_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_commercial = 1 then ha_closes end),0),0) as MAR2877C, -- ha_cpa_wn_il
    coalesce(sum(case when s.market_id = 42 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 42 and c.is_commercial = 1 then ha_closes end),0),0) as MAR2936C, -- ha_cpa_wn_il_ch,
    coalesce(sum(case when s.market_id = 57 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 57 and c.is_commercial = 1 then ha_closes end),0),0) as MAR2995C, -- ha_cpa_wn_il_na,
    coalesce(sum(case when s.market_id = 58 and s.is_commercial = 1 then ha_fee end) / nullif(sum(case when c.market_id = 58 and c.is_commercial = 1 then ha_closes end),0),0) as MAR3054C, -- ha_cpa_wn_il_la,
    -----------TT------------
    
    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then tt_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then tt_closes end),0),0) as MAR660D, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_commercial = 1 then tt_closes end),0),0) as MAR660C, 

    coalesce(sum(case when s.old_region = 'South California' and s.is_driveway = 1 then tt_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_driveway = 1 then tt_closes end),0),0) as SAL377D,
    coalesce(sum(case when s.old_region = 'South California' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_commercial = 1 then tt_closes end),0),0) as SAL377C,

    coalesce(sum(case when s.market like '%-TX-%' and s.is_driveway = 1 then tt_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_driveway = 1 then tt_closes end),0),0) as SAL598D, 
    coalesce(sum(case when s.market like '%-TX-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_commercial = 1 then tt_closes end),0),0) as SAL598C, 

    coalesce(sum(case when s.market_id = 3 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 3 and c.is_driveway = 1 then tt_closes end),0),0) as MAR447D, 
    coalesce(sum(case when s.market_id = 3 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 3 and c.is_commercial = 1 then tt_closes end),0),0) as MAR447C, 

    coalesce(sum(case when s.market_id = 2 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 2 and c.is_driveway = 1 then tt_closes end),0),0) as MAR444D, 
    coalesce(sum(case when s.market_id = 2 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 2 and c.is_commercial = 1 then tt_closes end),0),0) as MAR444C, 

    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then tt_closes end),0),0) as MAR446F, 
    coalesce(sum(case when s.market_id = 9 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 9 and c.is_driveway = 1 then tt_closes end),0),0) as MAR446D, 
    coalesce(sum(case when s.market_id = 9 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 9 and c.is_commercial = 1 then tt_closes end),0),0) as MAR446C, 

    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_driveway = 1 then tt_closes end),0),0) as MAR445D, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_commercial = 1 then tt_closes end),0),0) as MAR445C, 

    coalesce(sum(case when s.market_id = 10 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 10 and c.is_driveway = 1 then tt_closes end),0),0) as MAR448D, 
    coalesce(sum(case when s.market_id = 10 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 10 and c.is_commercial = 1 then tt_closes end),0),0) as MAR448C,

    coalesce(sum(case when s.market_id = 5 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 5 and c.is_driveway = 1 then tt_closes end),0),0) as SAL438D, 
    coalesce(sum(case when s.market_id = 5 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 5 and c.is_commercial = 1 then tt_closes end),0),0) as SAL438C,

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then tt_closes end),0),0) as SAL431D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then tt_closes end),0),0) as SAL431C, 

    coalesce(sum(case when s.market_id = 6 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 6 and c.is_driveway = 1 then tt_closes end),0),0) as SAL445D, 
    coalesce(sum(case when s.market_id = 6 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 6 and c.is_commercial = 1 then tt_closes end),0),0) as SAL445C, 

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then tt_closes end),0),0) as SAL530D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then tt_closes end),0),0) as SAL530C, 

    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then tt_closes end),0),0) as SAL587F, 
    coalesce(sum(case when s.market_id = 1 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 1 and c.is_driveway = 1 then tt_closes end),0),0) as SAL587D, 
    coalesce(sum(case when s.market_id = 1 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 1 and c.is_commercial = 1 then tt_closes end),0),0) as SAL587C, 

    coalesce(sum(case when s.market_id = 16 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 16 and c.is_driveway = 1 then tt_closes end),0),0) as SAL599D, 
    coalesce(sum(case when s.market_id = 16 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 16 and c.is_commercial = 1 then tt_closes end),0),0) as SAL599C, 

    coalesce(sum(case when s.market_id = 17 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 17 and c.is_driveway = 1 then tt_closes end),0),0) as SAL600D,
    coalesce(sum(case when s.market_id = 17 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 17 and c.is_commercial = 1 then tt_closes end),0),0) as SAL600C, 
    
    coalesce(sum(case when s.market_id = 4 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 4 and c.is_driveway = 1 then tt_closes end),0),0) as MAR892D, 
    coalesce(sum(case when s.market_id = 4 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 4 and c.is_commercial = 1 then tt_closes end),0),0) as MAR892C,

    coalesce(sum(case when s.market_id = 30 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 30 and c.is_driveway = 1 then tt_closes end),0),0) as MAR893D, 
    coalesce(sum(case when s.market_id = 30 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 30 and c.is_commercial = 1 then tt_closes end),0),0) as MAR893C,

    coalesce(sum(case when s.market_id = 31 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 31 and c.is_driveway = 1 then tt_closes end),0),0) as MAR894D, 
    coalesce(sum(case when s.market_id = 31 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 31 and c.is_commercial = 1 then tt_closes end),0),0) as MAR894C,

    coalesce(sum(case when s.market_id = 29 and s.is_driveway = 1 then tt_fee end) / nullif(sum(case when c.market_id = 29 and c.is_driveway = 1 then tt_closes end),0),0) as MAR895D, 
    coalesce(sum(case when s.market_id = 29 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 29 and c.is_commercial = 1 then tt_closes end),0),0) as MAR895C,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR1556C,
    coalesce(sum(case when s.market_id = 35 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 35 and c.is_commercial = 1 then tt_closes end),0),0) as MAR1526C,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR1600C,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR2294C,
    coalesce(sum(case when s.market_id = 24 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 24 and c.is_commercial = 1 then tt_closes end),0),0) as MAR1636C,
    coalesce(sum(case when s.market_id = 26 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 26 and c.is_commercial = 1 then tt_closes end),0),0) as MAR1684C,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR1212C, 

    coalesce(sum(case when s.market_id = 22 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 22 and c.is_commercial = 1 then tt_closes end),0),0) as MAR1143C, 
    coalesce(sum(case when s.market_id = 21 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 21 and c.is_commercial = 1 then tt_closes end),0),0) as MAR1184C, 

    coalesce(sum(case when s.market_id = 43 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 43 and c.is_commercial = 1 then tt_closes end),0),0) as MAR2252C,

    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then fb_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then fb_closes end),0),0) as SAL487D, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_commercial = 1 then fb_closes end),0),0) as SAL487C, 

    coalesce(sum(case when s.old_region = 'South California' and s.is_driveway = 1 then fb_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_driveway = 1 then fb_closes end),0),0) as SAL379D, 
    coalesce(sum(case when s.old_region = 'South California' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_commercial = 1 then fb_closes end),0),0) as SAL379C, 

    coalesce(sum(case when s.market like '%-TX-%' and s.is_driveway = 1 then fb_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_driveway = 1 then fb_closes end),0),0) as SAL601D, 
    coalesce(sum(case when s.market like '%-TX-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL601C, 

    coalesce(sum(case when s.market_id = 3 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 3 and c.is_driveway = 1 then fb_closes end),0),0) as MAR457D, 
    coalesce(sum(case when s.market_id = 3 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 3 and c.is_commercial = 1 then fb_closes end),0),0) as MAR457C, 

    coalesce(sum(case when s.market_id = 2 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 2 and c.is_driveway = 1 then fb_closes end),0),0) as MAR454D, 
    coalesce(sum(case when s.market_id = 2 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 2 and c.is_commercial = 1 then fb_closes end),0),0) as MAR454C, 

    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then fb_closes end),0),0) as MAR456F, 
    coalesce(sum(case when s.market_id = 9 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 9 and c.is_driveway = 1 then fb_closes end),0),0) as MAR456D, 
    coalesce(sum(case when s.market_id = 9 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 9 and c.is_commercial = 1 then fb_closes end),0),0) as MAR456C, 

    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_driveway = 1 then fb_closes end),0),0) as MAR455D, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_commercial = 1 then fb_closes end),0),0) as MAR455C, 

    coalesce(sum(case when s.market_id = 10 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 10 and c.is_driveway = 1 then fb_closes end),0),0) as MAR458D, 
    coalesce(sum(case when s.market_id = 10 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 10 and c.is_commercial = 1 then fb_closes end),0),0) as MAR458C, 

    coalesce(sum(case when s.market_id = 5 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 5 and c.is_driveway = 1 then fb_closes end),0),0) as SAL440D, 
    coalesce(sum(case when s.market_id = 5 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 5 and c.is_commercial = 1 then fb_closes end),0),0) as SAL440C, 

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then fb_closes end),0),0) as SAL433D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then fb_closes end),0),0) as SAL433C, 

    coalesce(sum(case when s.market_id = 6 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 6 and c.is_driveway = 1 then fb_closes end),0),0) as SAL447D, 
    coalesce(sum(case when s.market_id = 6 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 6 and c.is_commercial = 1 then fb_closes end),0),0) as SAL447C, 

    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then fb_closes end),0),0) as SAL532D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then fb_closes end),0),0) as SAL532C,

    coalesce(sum(case when s.market_id = 1 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 1 and c.is_driveway = 1 then fb_closes end),0),0) as SAL589D, 
    coalesce(sum(case when s.market_id = 1 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 1 and c.is_commercial = 1 then fb_closes end),0),0) as SAL589C, 

    coalesce(sum(case when s.market_id = 16 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 16 and c.is_driveway = 1 then fb_closes end),0),0) as SAL602D,
    coalesce(sum(case when s.market_id = 16 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 16 and c.is_commercial = 1 then fb_closes end),0),0) as SAL602C, 

    coalesce(sum(case when s.market_id = 17 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 17 and c.is_driveway = 1 then fb_closes end),0),0) as SAL603D, 
    coalesce(sum(case when s.market_id = 17 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 17 and c.is_commercial = 1 then fb_closes end),0),0) as SAL603C, 
    
    coalesce(sum(case when s.market_id = 4 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 4 and c.is_driveway = 1 then fb_closes end),0),0) as MAR896D, 
    coalesce(sum(case when s.market_id = 4 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 4 and c.is_commercial = 1 then fb_closes end),0),0) as MAR896C, 

    coalesce(sum(case when s.market_id = 30 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 30 and c.is_driveway = 1 then fb_closes end),0),0) as MAR897D, 
    coalesce(sum(case when s.market_id = 30 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 30 and c.is_commercial = 1 then fb_closes end),0),0) as MAR897C, 

    coalesce(sum(case when s.market_id = 31 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 31 and c.is_driveway = 1 then fb_closes end),0),0) as MAR898D, 
    coalesce(sum(case when s.market_id = 31 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 31 and c.is_commercial = 1 then fb_closes end),0),0) as MAR898C, 

    coalesce(sum(case when s.market_id = 29 and s.is_driveway = 1 then fb_fee end) / nullif(sum(case when c.market_id = 29 and c.is_driveway = 1 then fb_closes end),0),0) as MAR899D, 
    coalesce(sum(case when s.market_id = 29 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 29 and c.is_commercial = 1 then fb_closes end),0),0) as MAR899C, 
    coalesce(sum(case when s.market like '%-VA-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL893C, 
    coalesce(sum(case when s.market like '%-FL-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL914C, 
    coalesce(sum(case when s.market_id = 35 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 35 and c.is_commercial = 1 then fb_closes end),0),0) as MAR1528C,
    coalesce(sum(case when s.market_id = 24 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 24 and c.is_commercial = 1 then fb_closes end),0),0) as MAR1638C,
    coalesce(sum(case when s.market_id = 26 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 26 and c.is_commercial = 1 then fb_closes end),0),0) as MAR1686C,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL789C, 
    coalesce(sum(case when s.market_id = 22 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 22 and c.is_commercial = 1 then fb_closes end),0),0) as MAR1146C, 
    coalesce(sum(case when s.market_id = 21 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 21 and c.is_commercial = 1 then fb_closes end),0),0) as MAR1187C,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR1277C, 
    coalesce(sum(case when s.market like '%-PA-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL830C, 
    coalesce(sum(case when s.market_id = 33 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 33 and c.is_commercial = 1 then fb_closes end),0),0) as MAR1249C, 
    coalesce(sum(case when s.market like '%-GA-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL853C,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR1314C,  
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL1087C,  
    coalesce(sum(case when s.market_id = 43 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 43 and c.is_commercial = 1 then fb_closes end),0),0) as MAR2254C,
    
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_commercial = 1 then fb_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_commercial = 1 then fb_closes end),0),0) as SAL1159C, --Illinois
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_commercial = 1 then tt_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_commercial = 1 then tt_closes end),0),0) as MAR2878C,
    coalesce(sum(case when s.market_id = 42 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 42 and c.is_commercial = 1 then tt_closes end),0),0) as MAR2937C,
    coalesce(sum(case when s.market_id = 57 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 57 and c.is_commercial = 1 then tt_closes end),0),0) as MAR2996C,
    coalesce(sum(case when s.market_id = 58 and s.is_commercial = 1 then tt_fee end) / nullif(sum(case when c.market_id = 58 and c.is_commercial = 1 then tt_closes end),0),0) as MAR3055C,
    coalesce(sum(case when s.market_id = 42 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 42 and c.is_commercial = 1 then fb_closes end),0),0) as MAR2939C,
    coalesce(sum(case when s.market_id = 57 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 57 and c.is_commercial = 1 then fb_closes end),0),0) as MAR2998C,
    coalesce(sum(case when s.market_id = 58 and s.is_commercial = 1 then fb_fee end) / nullif(sum(case when c.market_id = 58 and c.is_commercial = 1 then fb_closes end),0),0) as MAR3057C,
    -----------GG------------    
    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then gg_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then gg_closes end),0),0) as MAR661D, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_commercial = 1 then gg_closes end),0),0) as MAR661C, 
    coalesce(sum(case when s.old_region = 'South California' and s.is_driveway = 1 then gg_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_driveway = 1 then gg_closes end),0),0) as SAL378D, -- gg_cpa_sc,
    coalesce(sum(case when s.old_region = 'South California' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_commercial = 1 then gg_closes end),0),0) as SAL378C, -- gg_cpa_sc,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_driveway = 1 then gg_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_driveway = 1 then gg_closes end),0),0) as SAL604D, -- gg_cpa_tx,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_commercial = 1 then gg_closes end),0),0) as SAL604C, -- gg_cpa_tx,
    coalesce(sum(case when s.market_id = 3 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 3 and c.is_driveway = 1 then gg_closes end),0),0) as MAR452D, 
    coalesce(sum(case when s.market_id = 3 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 3 and c.is_commercial = 1 then gg_closes end),0),0) as MAR452C, 
    coalesce(sum(case when s.market_id = 2 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 2 and c.is_driveway = 1 then gg_closes end),0),0) as MAR449D, 
    coalesce(sum(case when s.market_id = 2 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 2 and c.is_commercial = 1 then gg_closes end),0),0) as MAR449C, 
    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then gg_closes end),0),0) as MAR451F,
    coalesce(sum(case when s.market_id = 9 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 9 and c.is_driveway = 1 then gg_closes end),0),0) as MAR451D, 
    coalesce(sum(case when s.market_id = 9 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 9 and c.is_commercial = 1 then gg_closes end),0),0) as MAR451C,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_driveway = 1 then gg_closes end),0),0) as MAR450D, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_commercial = 1 then gg_closes end),0),0) as MAR450C, 
    coalesce(sum(case when s.market_id = 10 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 10 and c.is_driveway = 1 then gg_closes end),0),0) as MAR453D, 
    coalesce(sum(case when s.market_id = 10 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 10 and c.is_commercial = 1 then gg_closes end),0),0) as MAR453C, 
    coalesce(sum(case when s.market_id = 5 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 5 and c.is_driveway = 1 then gg_closes end),0),0) as SAL439D,
    coalesce(sum(case when s.market_id = 5 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 5 and c.is_commercial = 1 then gg_closes end),0),0) as SAL439C, 
    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then gg_closes end),0),0) as SAL432D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then gg_closes end),0),0) as SAL432C, 
    coalesce(sum(case when s.market_id = 6 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 6 and c.is_driveway = 1 then gg_closes end),0),0) as SAL446D,
    coalesce(sum(case when s.market_id = 6 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 6 and c.is_commercial = 1 then gg_closes end),0),0) as SAL446C, 
    coalesce(sum(case when s.market_id = 14 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 14 and c.is_driveway = 1 then gg_closes end),0),0) as SAL531D, 
    coalesce(sum(case when s.market_id = 14 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 14 and c.is_commercial = 1 then gg_closes end),0),0) as SAL531C, 
    coalesce(sum(case when s.market_id = 1 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 1 and c.is_driveway = 1 then gg_closes end),0),0) as SAL588D, 
    coalesce(sum(case when s.market_id = 1 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 1 and c.is_commercial = 1 then gg_closes end),0),0) as SAL588C,
    coalesce(sum(case when s.market_id = 16 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 16 and c.is_driveway = 1 then gg_closes end),0),0) as SAL605D, 
    coalesce(sum(case when s.market_id = 16 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 16 and c.is_commercial = 1 then gg_closes end),0),0) as SAL605C, 
    coalesce(sum(case when s.market_id = 17 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 17 and c.is_driveway = 1 then gg_closes end),0),0) as SAL606D, 
    coalesce(sum(case when s.market_id = 17 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 17 and c.is_commercial = 1 then gg_closes end),0),0) as SAL606C,   
    coalesce(sum(case when s.market_id = 4 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 4 and c.is_driveway = 1 then gg_closes end),0),0) as MAR900D, 
    coalesce(sum(case when s.market_id = 4 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 4 and c.is_commercial = 1 then gg_closes end),0),0) as MAR900C, 
    coalesce(sum(case when s.market_id = 30 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 30 and c.is_driveway = 1 then gg_closes end),0),0) as MAR901D, 
    coalesce(sum(case when s.market_id = 30 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 30 and c.is_commercial = 1 then gg_closes end),0),0) as MAR901C, 
    coalesce(sum(case when s.market_id = 31 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 31 and c.is_driveway = 1 then gg_closes end),0),0) as MAR902D, 
    coalesce(sum(case when s.market_id = 31 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 31 and c.is_commercial = 1 then gg_closes end),0),0) as MAR902C, 
    coalesce(sum(case when s.market_id = 29 and s.is_driveway = 1 then gg_fee end) / nullif(sum(case when c.market_id = 29 and c.is_driveway = 1 then gg_closes end),0),0) as MAR903D, 
    coalesce(sum(case when s.market_id = 29 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 29 and c.is_commercial = 1 then gg_closes end),0),0) as MAR903C, 
    coalesce(sum(case when s.market like '%-MD-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR1213C, 
    coalesce(sum(case when s.market_id = 22 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 22 and c.is_commercial = 1 then gg_closes end),0),0) as MAR1144C, 
    coalesce(sum(case when s.market_id = 21 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 21 and c.is_commercial = 1 then gg_closes end),0),0) as MAR1185C,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR1557C,
    coalesce(sum(case when s.market_id = 35 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 35 and c.is_commercial = 1 then gg_closes end),0),0) as MAR1527C,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR1601C,
    coalesce(sum(case when s.market_id = 24 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 24 and c.is_commercial = 1 then gg_closes end),0),0) as MAR1637C,
    coalesce(sum(case when s.market_id = 26 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 26 and c.is_commercial = 1 then gg_closes end),0),0) as MAR1685C,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR1278C,
    coalesce(sum(case when s.market_id = 33 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 33 and c.is_commercial = 1 then gg_closes end),0),0) as MAR1248C, 
    coalesce(sum(case when s.market like '%-GA-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR1315C,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR2295C,
    coalesce(sum(case when s.market_id = 43 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 43 and c.is_commercial = 1 then gg_closes end),0),0) as MAR2253C,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_commercial = 1 then gg_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_commercial = 1 then gg_closes end),0),0) as MAR2879C,
    coalesce(sum(case when s.market_id = 42 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 42 and c.is_commercial = 1 then gg_closes end),0),0) as MAR2938C,
    coalesce(sum(case when s.market_id = 57 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 57 and c.is_commercial = 1 then gg_closes end),0),0) as MAR2997C,
    coalesce(sum(case when s.market_id = 58 and s.is_commercial = 1 then gg_fee end) / nullif(sum(case when c.market_id = 58 and c.is_commercial = 1 then gg_closes end),0),0) as MAR3056C,
-----------bo------------ 
    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then bo_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then bo_closes end),0),0) as SAL500D, -- bo_cpa_nc,
    coalesce(sum(case when s.old_region = 'North California' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_commercial = 1 then bo_closes end),0),0) as SAL500C, -- bo_cpa_nc,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then bo_closes end),0),0) as SAL537F, -- bo_cpa_sac,
    coalesce(sum(case when s.market_id = 3 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 3 and c.is_driveway = 1 then bo_closes end),0),0) as SAL537D, -- bo_cpa_sac,
    coalesce(sum(case when s.market_id = 3 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 3 and c.is_commercial = 1 then bo_closes end),0),0) as SAL537C, -- bo_cpa_sac,
    coalesce(sum(case when s.market_id = 2 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 2 and c.is_driveway = 1 then bo_closes end),0),0) as SAL535D, -- bo_cpa_eb,
    coalesce(sum(case when s.market_id = 2 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 2 and c.is_commercial = 1 then bo_closes end),0),0) as SAL535C, -- bo_cpa_eb,
    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then bo_closes end),0),0) as SAL536F, -- bo_cpa_nb,
    coalesce(sum(case when s.market_id = 9 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 9 and c.is_driveway = 1 then bo_closes end),0),0) as SAL536D, -- bo_cpa_nb,
    coalesce(sum(case when s.market_id = 9 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 9 and c.is_commercial = 1 then bo_closes end),0),0) as SAL536C, -- bo_cpa_nb,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id in (4,30,31) and c.is_driveway = 1 then bo_closes end),0),0) as SAL501D, -- bo_cpa_sb,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id in (4,30,31) and c.is_commercial = 1 then bo_closes end),0),0) as SAL501C, -- bo_cpa_sb
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then bo_closes end),0),0) as SAL538F, -- bo_cpa_fr,
    coalesce(sum(case when s.market_id = 10 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 10 and c.is_driveway = 1 then bo_closes end),0),0) as SAL538D, -- bo_cpa_fr,
    coalesce(sum(case when s.market_id = 10 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 10 and c.is_commercial = 1 then bo_closes end),0),0) as SAL538C, -- bo_cpa_fr,   
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then bo_closes end),0),0) as SAL675F, 
    coalesce(sum(case when s.market_id = 4 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 4 and c.is_driveway = 1 then bo_closes end),0),0) as SAL675D, 
    coalesce(sum(case when s.market_id = 4 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 4 and c.is_commercial = 1 then bo_closes end),0),0) as SAL675C,
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then bo_closes end),0),0) as SAL676F,
    coalesce(sum(case when s.market_id = 30 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 30 and c.is_driveway = 1 then bo_closes end),0),0) as SAL676D, 
    coalesce(sum(case when s.market_id = 30 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 30 and c.is_commercial = 1 then bo_closes end),0),0) as SAL676C, 
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then bo_closes end),0),0) as SAL677F, 
    coalesce(sum(case when s.market_id = 31 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 31 and c.is_driveway = 1 then bo_closes end),0),0) as SAL677D, 
    coalesce(sum(case when s.market_id = 31 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 31 and c.is_commercial = 1 then bo_closes end),0),0) as SAL677C, 
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then bo_closes end),0),0) as SAL678F, 
    coalesce(sum(case when s.market_id = 29 and s.is_driveway = 1 then bo_fee end) / nullif(sum(case when c.market_id = 29 and c.is_driveway = 1 then bo_closes end),0),0) as SAL678D,
    coalesce(sum(case when s.market_id = 29 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 29 and c.is_commercial = 1 then bo_closes end),0),0) as SAL678C,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL790C, -- bo_cpa_md,
    coalesce(sum(case when s.market_id = 22 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 22 and c.is_commercial = 1 then bo_closes end),0),0) as SAL749C, -- bo_cpa_bl,
    coalesce(sum(case when s.market_id = 21 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 21 and c.is_commercial = 1 then bo_closes end),0),0) as SAL769C, -- bo_cpa_dc,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL831C, -- bo_cpa_pen,
    coalesce(sum(case when s.market_id = 33 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 33 and c.is_commercial = 1 then bo_closes end),0),0) as SAL810C, -- bo_cpa_ph,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL854C, -- bo_cpa_ga,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL894C, -- bo_cpa_va,
    coalesce(sum(case when s.market_id = 35 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 35 and c.is_commercial = 1 then bo_closes end),0),0) as SAL873C, -- bo_cpa_ar,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL915C, -- bo_cpa_fl,
    coalesce(sum(case when s.market_id = 24 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 24 and c.is_commercial = 1 then bo_closes end),0),0) as SAL935C, -- bo_cpa_mi,
    coalesce(sum(case when s.market_id = 26 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 26 and c.is_commercial = 1 then bo_closes end),0),0) as SAL955C, -- bo_cpa_or,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL1088C, -- bo_cpa_pa_wa,
    coalesce(sum(case when s.market_id = 43 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 43 and c.is_commercial = 1 then bo_closes end),0),0) as SAL1062C, -- bo_cpa_bl,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_commercial = 1 then bo_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_commercial = 1 then bo_closes end),0),0) as SAL1160C, -- bo_cpa_wn_il,
    coalesce(sum(case when s.market_id = 42 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 42 and c.is_commercial = 1 then bo_closes end),0),0) as SAL1182C, -- bo_cpa_wn_il_ch,
    coalesce(sum(case when s.market_id = 57 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 57 and c.is_commercial = 1 then bo_closes end),0),0) as SAL1205C, -- bo_cpa_wn_il_na,
    coalesce(sum(case when s.market_id = 58 and s.is_commercial = 1 then bo_fee end) / nullif(sum(case when c.market_id = 58 and c.is_commercial = 1 then bo_closes end),0),0) as SAL1228C -- bo_cpa_wn_il_la
    from timeseries t
    left join spend s on s.lead_arrived_at = t.date
    left join final_closes c on c.close_date = t.date
                             and s.market = c.market
                             and s.old_region = c.old_region
                             and s.market_id = c.market_id
                             and s.region = c.region
                             and s.is_fence = c.is_fence
                             and s.is_commercial = c.is_commercial
                             and s.is_turf = c.is_turf
                             and s.is_driveway = c.is_driveway
    group by 1),
comex as(
    select 
    f.date as date,
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then total_closes end),0),0) as SAL471F, -- cpa_nc,
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then ha_closes end),0),0) as MAR659F, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then tt_closes end),0),0) as MAR660F, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then ba_closes end),0),0) as MAR1327F,
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then nd_closes end),0),0) as MAR1328F,
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then total_closes end),0),0) as SAL240F, -- cpa_eb,
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then ha_closes end),0),0) as MAR439F, -- ha_cpa_eb,
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then tt_closes end),0),0) as MAR444F, 
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then ba_closes end),0),0) as MAR1333F,
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then nd_closes end),0),0) as MAR1334F,
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then total_closes end),0),0) as SAL244F, -- cpa_sf,
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then ha_closes end),0),0) as MAR2487F, -- ha_cpa_sf,
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then tt_closes end),0),0) as MAR2488F, 
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then ba_closes end),0),0) as MAR2498F,
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then nd_closes end),0),0) as MAR2499F,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_fence = 1 then ha_closes end),0),0) as MAR440F,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_fence = 1 then tt_closes end),0),0) as MAR445F, 
    coalesce(sum(case when s.market_id in (4,30,31,8) and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id in (4,30,31,8) and c.is_fence = 1 then ba_closes end),0),0) as MAR1339F,
    coalesce(sum(case when s.market_id in (4,30,31,8) and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id in (4,30,31,8) and c.is_fence = 1 then nd_closes end),0),0) as MAR1340F,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then total_closes end),0),0) as SAL241F, -- cpa_sac,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then ha_closes end),0),0) as MAR442F, -- ha_cpa_sac,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then tt_closes end),0),0) as MAR447F,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then ba_closes end),0),0) as MAR1351F,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then nd_closes end),0),0) as MAR1352F, 
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then ha_closes end),0),0) as MAR891F, 
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then tt_closes end),0),0) as MAR895F,
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then ba_closes end),0),0) as MAR1357F,
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then nd_closes end),0),0) as MAR1358F, 
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then total_closes end),0),0) as SAL245F, -- cpa_fr,
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then tt_closes end),0),0) as MAR448F, 
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then ba_closes end),0),0) as MAR1363F,
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then nd_closes end),0),0) as MAR1364F,
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then ha_closes end),0),0) as MAR888F, 
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then tt_closes end),0),0) as MAR892F, 
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then ba_closes end),0),0) as MAR1369F,
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then nd_closes end),0),0) as MAR1370F,
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then ha_closes end),0),0) as MAR889F, 
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then tt_closes end),0),0) as MAR893F, 
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then ba_closes end),0),0) as MAR1375F,
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then nd_closes end),0),0) as MAR1376F,
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then tt_closes end),0),0) as MAR894F, 
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then ba_closes end),0),0) as MAR1381F,
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then nd_closes end),0),0) as MAR1382F,
    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then ba_closes end),0),0) as MAR1345F,
    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then nd_closes end),0),0) as MAR1346F,
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then total_closes end),0),0) as SAL375F, -- cpa_sc,
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then ha_closes end),0),0) as SAL376F, -- ha_cpa_sc,
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then tt_closes end),0),0) as SAL377F, 
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then ba_closes end),0),0) as MAR1387F,
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then nd_closes end),0),0) as MAR1388F,
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then total_closes end),0),0) as SAL429F, -- cpa_sv,
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then ha_closes end),0),0) as SAL430F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then tt_closes end),0),0) as SAL431F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then ba_closes end),0),0) as MAR1395F,
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then nd_closes end),0),0) as MAR1396F,
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then ha_closes end),0),0) as SAL437F, 
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then tt_closes end),0),0) as SAL438F, 
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then ba_closes end),0),0) as MAR1401F,
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then nd_closes end),0),0) as MAR1402F,
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then total_closes end),0),0) as SAL443F, -- cpa_la,
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then ha_closes end),0),0) as SAL444F, 
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then tt_closes end),0),0) as SAL445F, 
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then ba_closes end),0),0) as MAR1407F,
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then nd_closes end),0),0) as MAR1408F,
    coalesce(sum(case when s.market_id = 7 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 7 and c.is_fence = 1 then total_closes end),0),0) as SAL528F, -- cpa_vc,
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then ha_closes end),0),0) as SAL529F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then tt_closes end),0),0) as SAL530F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then ba_closes end),0),0) as MAR1413F,
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then nd_closes end),0),0) as MAR1414F,
    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then total_closes end),0),0) as SAL585F, -- cpa_sd,
    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then ba_closes end),0),0) as MAR1419F,
    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then nd_closes end),0),0) as MAR1420F,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then total_closes end),0),0) as SAL592F, -- cpa_tx,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then ha_closes end),0),0) as SAL595F, -- ha_cpa_tx,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then tt_closes end),0),0) as SAL598F, 
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR1425F,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR1426F,
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then total_closes end),0),0) as SAL593F, -- cpa_dl,
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then ha_closes end),0),0) as SAL596F,
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then tt_closes end),0),0) as SAL599F, 
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then ba_closes end),0),0) as MAR1431F,
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then nd_closes end),0),0) as MAR1432F,
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then total_closes end),0),0) as SAL594F, -- cpa_fw,
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then ha_closes end),0),0) as SAL597F, 
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then tt_closes end),0),0) as SAL600F,
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then ba_closes end),0),0) as MAR1437F,
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then nd_closes end),0),0) as MAR1438F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then ba_closes end),0),0) as MAR1443F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then nd_closes end),0),0) as MAR1444F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 19 and c.is_fence = 1 then ba_closes end),0),0) as MAR1449F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 19 and c.is_fence = 1 then nd_closes end),0),0) as MAR1450F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then ba_closes end),0),0) as MAR1455F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then nd_closes end),0),0) as MAR1456F,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then total_closes end),0),0) as SAL773F, -- cpa_md,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then total_closes end),0),0) as SAL959F, -- cpa_ne,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR1211F, 
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then ha_closes end),0),0) as MAR2043F, 
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR1212F,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then tt_closes end),0),0) as MAR2044F,  
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR1473F,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR1474F,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then ba_closes end),0),0) as MAR2057F,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then nd_closes end),0),0) as MAR2058F,
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then total_closes end),0),0) as SAL733F, -- cpa_bl,
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then ha_closes end),0),0) as MAR1142F, -- ha_cpa_bl,
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then tt_closes end),0),0) as MAR1143F, 
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then ba_closes end),0),0) as MAR1479F,
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then nd_closes end),0),0) as MAR1480F,
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then total_closes end),0),0) as SAL753F, -- cpa_dc,
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then ha_closes end),0),0) as MAR2251F, -- ha_cpa_se,
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then tt_closes end),0),0) as MAR2252F, 
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then ba_closes end),0),0) as MAR2267F,
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then nd_closes end),0),0) as MAR2268F,
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then total_closes end),0),0) as SAL1045F, -- cpa_se,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR1570F,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR1571F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR1649F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR1650F,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then total_closes end),0),0) as SAL877F, -- cpa_va,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then total_closes end),0),0) as SAL898F, -- cpa_fl,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR1555F,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR1556F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR1600F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR1599F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then ba_closes end),0),0) as MAR1576F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then nd_closes end),0),0) as MAR1577F,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then ba_closes end),0),0) as MAR1651F,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then nd_closes end),0),0) as MAR1652F,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then ba_closes end),0),0) as MAR1697F,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then nd_closes end),0),0) as MAR1698F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then total_closes end),0),0) as SAL857F, -- cpa_ar,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then total_closes end),0),0) as SAL919F, -- cpa_mi,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then total_closes end),0),0) as SAL939F, -- cpa_mi,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then total_closes end),0),0) as SAL794F, -- cpa_ph,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then ha_closes end),0),0) as MAR1525F, -- ha_cpa_ar,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then tt_closes end),0),0) as MAR1526F,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then ha_closes end),0),0) as MAR1635F, -- ha_cpa_mi,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then tt_closes end),0),0) as MAR1636F,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then ha_closes end),0),0) as MAR1683F, -- ha_cpa_mi,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then tt_closes end),0),0) as MAR1684F,
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then ha_closes end),0),0) as MAR1183F, -- ha_cpa_dc,
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then tt_closes end),0),0) as MAR1184F, 
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then ba_closes end),0),0) as MAR1485F,
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then nd_closes end),0),0) as MAR1486F,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then total_closes end),0),0) as SAL814F, -- cpa_pa,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR1276F, 
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR1277F, 
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR1491F,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR1492F,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then ha_closes end),0),0) as MAR1246F, -- ha_cpa_ph,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then tt_closes end),0),0) as MAR1247F, 
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then ba_closes end),0),0) as MAR1497F,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then nd_closes end),0),0) as MAR1498F,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then total_closes end),0),0) as SAL837F, -- cga_nc,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR1313F, 
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then tt_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR1314F,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR1461F,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR1462F,
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then ba_closes end),0),0) as MAR1467F,
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then nd_closes end),0),0) as MAR1468F,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then total_closes end),0),0) as SAL1071F, -- cpa_pa_wa,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR2305F,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR2306F,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR2293F,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR2294F,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then total_closes end),0),0) as SAL1143F, -- cpa_Illinois,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then ba_closes end),0),0) as MAR2508F, 
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then nd_closes end),0),0) as MAR2509F,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then ha_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then ha_closes end),0),0) as MAR2877F,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then tt_closes end),0),0) as MAR2878F,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then ba_closes end),0),0) as MAR2891F,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then nd_closes end),0),0) as MAR2892F,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then ha_closes end),0),0) as MAR2936F, -- ha_cpa_wn_il,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then tt_closes end),0),0) as MAR2937F,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then total_closes end),0),0) as SAL1166F, -- cpa_wn_il,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then ba_closes end),0),0) as MAR2950F,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then nd_closes end),0),0) as MAR2951F,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then ha_closes end),0),0) as MAR2995F, -- ha_cpa_wn_il,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then tt_closes end),0),0) as MAR2996F,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then total_closes end),0),0) as SAL1189F, -- cpa_wn_il,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then ba_fee end)/nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then ba_closes end),0),0) as MAR3009F,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then nd_fee end)/nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then nd_closes end),0),0) as MAR3010F,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then ha_closes end),0),0) as MAR3054F, -- ha_cpa_wn_il,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then tt_closes end),0),0) as MAR3055F,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then total_closes end),0),0) as SAL1212F, -- cpa_wn_il,
    --Turf--
    coalesce(sum(case when s.old_region = 'South California' and s.is_turf = 1 then total_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_turf = 1 then total_closes end),0),0) as SAL375T, -- cpa_sc,
    coalesce(sum(case when s.market_id = 14 and s.is_turf = 1 then total_fee end) / nullif(sum(case when c.market_id = 14 and c.is_turf = 1 then total_closes end),0),0) as SAL429T, -- cpa_sv,
    coalesce(sum(case when s.market_id = 6 and s.is_turf = 1 then total_fee end) / nullif(sum(case when c.market_id = 6 and c.is_turf = 1 then total_closes end),0),0) as SAL443T, -- cpa_la,
    coalesce(sum(case when s.market_id = 7 and s.is_turf = 1 then total_fee end) / nullif(sum(case when c.market_id = 7 and c.is_turf = 1 then total_closes end),0),0) as SAL528T, -- cpa_vc,

    -----------New metrics which converted from calculated metrics---------------
    --Fence--
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then yp_closes end),0),0) as MAR663F, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then ms_closes end),0),0) as MAR664F, 
    coalesce(sum(case when s.market_id=2  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=2 and c.is_fence = 1 then yp_closes end),0),0) as MAR459F, 
    coalesce(sum(case when s.market_id=2 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=2 and c.is_fence = 1 then ms_closes end),0),0) as MAR464F, 
    coalesce(sum(case when s.market_id=8  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=8 and c.is_fence = 1 then yp_closes end),0),0) as MAR2491F, 
    coalesce(sum(case when s.market_id=8 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=8 and c.is_fence = 1 then ms_closes end),0),0) as MAR2492F, 
    coalesce(sum(case when s.market_id in (4,30,31)  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id in (4,30,31) and c.is_fence = 1 then yp_closes end),0),0) as MAR460F, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id in (4,30,31) and c.is_fence = 1 then ms_closes end),0),0) as MAR465F, 
    coalesce(sum(case when s.market_id=9  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=9 and c.is_fence = 1 then yp_closes end),0),0) as MAR461F, 
    coalesce(sum(case when s.market_id=9 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=9 and c.is_fence = 1 then ms_closes end),0),0) as MAR466F, 
    coalesce(sum(case when s.market_id=3  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=3 and c.is_fence = 1 then yp_closes end),0),0) as MAR462F, 
    coalesce(sum(case when s.market_id=3 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=3 and c.is_fence = 1 then ms_closes end),0),0) as MAR467F, 
    coalesce(sum(case when s.market_id=10  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=10 and c.is_fence = 1 then yp_closes end),0),0) as MAR463F, 
    coalesce(sum(case when s.market_id=10 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=10 and c.is_fence = 1 then ms_closes end),0),0) as MAR468F, 
    coalesce(sum(case when c.old_region = 'South California' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.old_region = 'South California' and c.is_fence = 1 then yp_closes end),0),0) as SAL380F, 
    coalesce(sum(case when c.old_region = 'South California' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.old_region = 'South California' and c.is_fence = 1 then ms_closes end),0),0) as SAL381F, 
    coalesce(sum(case when s.market_id=14  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=14 and c.is_fence = 1 then yp_closes end),0),0) as SAL434F, 
    coalesce(sum(case when s.market_id=14 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=14 and c.is_fence = 1 then ms_closes end),0),0) as SAL435F, 
    coalesce(sum(case when s.market_id=5  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=5 and c.is_fence = 1 then yp_closes end),0),0) as SAL441F, 
    coalesce(sum(case when s.market_id=5 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=5 and c.is_fence = 1 then ms_closes end),0),0) as SAL442F, 
    coalesce(sum(case when s.market_id=6  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=6 and c.is_fence = 1 then yp_closes end),0),0) as SAL448F, 
    coalesce(sum(case when s.market_id=6 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=6 and c.is_fence = 1 then ms_closes end),0),0) as SAL449F, 
    coalesce(sum(case when s.market_id=14  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=14 and c.is_fence = 1 then yp_closes end),0),0) as SAL533F, 
    coalesce(sum(case when s.market_id=14 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=14 and c.is_fence = 1 then ms_closes end),0),0) as SAL534F, 
    coalesce(sum(case when s.market_id=1  and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id=1 and c.is_fence = 1 then yp_closes end),0),0) as SAL590F, 
    coalesce(sum(case when s.market_id=1 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id=1 and c.is_fence = 1 then ms_closes end),0),0) as SAL591F, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then bo_closes end),0),0) as SAL500F, -- bo_cpa_nc,
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then gg_closes end),0),0) as MAR661F,
    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then fb_closes end),0),0) as SAL487F, 
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then bo_closes end),0),0) as SAL535F, -- bo_cpa_eb,
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then gg_closes end),0),0) as MAR449F, 
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then fb_closes end),0),0) as MAR454F, 
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then bo_closes end),0),0) as SAL1135F, -- bo_cpa_sf,
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then gg_closes end),0),0) as MAR2489F, 
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then fb_closes end),0),0) as MAR2490F, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id in (4,30,31) and c.is_fence = 1 then bo_closes end),0),0) as SAL501F, -- bo_cpa_sb,
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_fence = 1 then gg_closes end),0),0) as MAR450F, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id in ( 4,30,31) and c.is_fence = 1 then fb_closes end),0),0) as MAR455F, 
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then gg_closes end),0),0) as MAR452F,
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then gg_closes end),0),0) as MAR903F, 
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then fb_closes end),0),0) as MAR899F, 
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then gg_closes end),0),0) as MAR453F, 
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then fb_closes end),0),0) as MAR458F, 
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then gg_closes end),0),0) as MAR900F, 
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then fb_closes end),0),0) as MAR896F, 
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then gg_closes end),0),0) as MAR901F, 
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then fb_closes end),0),0) as MAR897F, 
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then gg_closes end),0),0) as MAR902F, 
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then fb_closes end),0),0) as MAR898F, 
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then gg_closes end),0),0) as SAL378F, -- gg_cpa_sc,
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then fb_closes end),0),0) as SAL379F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then gg_closes end),0),0) as SAL432F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then fb_closes end),0),0) as SAL433F, 
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then gg_closes end),0),0) as SAL439F, 
    coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then fb_closes end),0),0) as SAL440F, 
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then gg_closes end),0),0) as SAL446F, 
    coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then fb_closes end),0),0) as SAL447F, 
    coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then gg_closes end),0),0) as SAL531F, 
    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then gg_closes end),0),0) as SAL588F,
    coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then fb_closes end),0),0) as SAL589F, 
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL601F,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then gg_closes end),0),0) as SAL604F, -- gg_cpa_tx,
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then fb_closes end),0),0) as SAL602F, 
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then gg_closes end),0),0) as SAL605F, 
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then gg_closes end),0),0) as SAL606F,
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then yp_closes end),0),0) as MAR986F, 
    coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then ms_closes end),0),0) as MAR987F, 
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then yp_closes end),0),0) as MAR990F,
    coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then ms_closes end),0),0) as MAR991F,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR992F,
    coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then ms_closes end),0),0) as MAR993F,
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then total_closes end),0),0) as MAR980F,
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then ha_closes end),0),0) as MAR975F,
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then tt_closes end),0),0) as MAR979F,
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then bo_closes end),0),0) as MAR981F,  
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then yp_closes end),0),0) as MAR977F, 
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then ms_closes end),0),0) as MAR978F, 
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then gg_closes end),0),0) as MAR976F, 
    coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then fb_closes end),0),0) as MAR974F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then total_closes end),0),0) as MAR1019F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then ha_closes end),0),0) as MAR1020F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then tt_closes end),0),0) as MAR1021F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then bo_closes end),0),0) as MAR1022F, 
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then gg_closes end),0),0) as MAR1023F,  
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then fb_closes end),0),0) as MAR1024F,  
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then yp_closes end),0),0) as MAR1025F,
    coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then ms_closes end),0),0) as MAR1026F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then total_closes end),0),0) as MAR1086F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then ha_closes end),0),0) as MAR1087F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then tt_closes end),0),0) as MAR1088F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then bo_closes end),0),0) as MAR1089F, 
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then gg_closes end),0),0) as MAR1090F,  
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then fb_closes end),0),0) as MAR1091F,  
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then yp_closes end),0),0) as MAR1092F,
    coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then ms_closes end),0),0) as MAR1093F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then total_fee end) / nullif(sum(case when c.market_id = 19 and c.is_fence = 1 then total_closes end),0),0) as MAR1048F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then ha_fee end) / nullif(sum(case when c.market_id = 19 and c.is_fence = 1 then ha_closes end),0),0) as MAR1049F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then tt_fee end) / nullif(sum(case when c.market_id = 19 and c.is_fence = 1 then tt_closes end),0),0) as MAR1050F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id =19 and c.is_fence = 1 then bo_closes end),0),0) as MAR1051F, 
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id =19 and c.is_fence = 1 then gg_closes end),0),0) as MAR1052F,  
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id =19 and c.is_fence = 1 then fb_closes end),0),0) as MAR1053F,  
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when c.market_id =19 and c.is_fence = 1 then yp_closes end),0),0) as MAR1054F,
    coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when c.market_id =19 and c.is_fence = 1 then ms_closes end),0),0) as MAR1055F,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then bo_closes end),0),0) as SAL975F, -- ne_cpa_md,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL790F, -- bo_cpa_md,
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR1213F,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then gg_closes end),0),0) as MAR2045F,
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then fb_closes end),0),0) as SAL974F, 
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL789F, 
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR1214F, 
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then yp_closes end),0),0) as MAR2046F, 
    coalesce(sum(case when s.market like '%-MD-%' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like '%-MD-%' and c.is_fence = 1 then ms_closes end),0),0) as MAR1215F, 
    coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then ms_closes end),0),0) as MAR2047F, 
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then bo_closes end),0),0) as SAL749F, -- bo_cpa_bl,
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then gg_closes end),0),0) as MAR1144F, 
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then fb_closes end),0),0) as MAR1146F, 
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when s.market_id = 22 and c.is_fence = 1 then yp_closes end),0),0) as MAR1147F, 
    coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when s.market_id = 22 and c.is_fence = 1 then ms_closes end),0),0) as MAR1148F, 
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then bo_closes end),0),0) as SAL769F, -- bo_cpa_dc,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then bo_closes end),0),0) as SAL810F, -- bo_cpa_ph,
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then gg_closes end),0),0) as MAR1185F,
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when s.market_id = 43 and c.is_fence = 1 then yp_closes end),0),0) as MAR2256F,
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when s.market_id = 43 and c.is_fence = 1 then ms_closes end),0),0) as MAR2257F, 
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then gg_closes end),0),0) as MAR2253F, 
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then fb_closes end),0),0) as MAR2254F, 
    coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then bo_closes end),0),0) as SAL1063F, -- bo_cpa_bl,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL894F, -- bo_cpa_va,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL893F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL915F, -- bo_cpa_fl,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL914F,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then ms_closes end),0),0) as MAR1559F, 
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR1558F,
    coalesce(sum(case when s.market like '%-VA-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like '%-VA-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR1557F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then ms_closes end),0),0) as MAR1603F, 
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR1602F,
    coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR1601F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then bo_closes end),0),0) as SAL873F, -- bo_cpa_ar,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then bo_closes end),0),0) as SAL935F, -- bo_cpa_mi,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then bo_closes end),0),0) as SAL955F, -- bo_cpa_or,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then gg_closes end),0),0) as MAR1527F,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then gg_closes end),0),0) as MAR1637F,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then gg_closes end),0),0) as MAR1685F,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then gg_closes end),0),0) as MAR1248F, 
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then fb_closes end),0),0) as MAR1187F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then fb_closes end),0),0) as MAR1528F,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then fb_closes end),0),0) as MAR1638F,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then fb_closes end),0),0) as MAR1686F,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then fb_closes end),0),0) as MAR1249F, 
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id = 21 and c.is_fence = 1 then yp_closes end),0),0) as MAR1188F,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id = 33 and c.is_fence = 1 then yp_closes end),0),0) as MAR1250F, 
    coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id = 21 and c.is_fence = 1 then ms_closes end),0),0) as MAR1189F,
    coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id = 33 and c.is_fence = 1 then ms_closes end),0),0) as MAR1251F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id = 35 and c.is_fence = 1 then ms_closes end),0),0) as MAR1530F,
    coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id = 35 and c.is_fence = 1 then yp_closes end),0),0) as MAR1529F, 
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id = 24 and c.is_fence = 1 then ms_closes end),0),0) as MAR1640F,
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then ms_fee end)/nullif(sum(case when s.market_id = 26 and c.is_fence = 1 then ms_closes end),0),0) as MAR1688F,
    coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id = 24 and c.is_fence = 1 then yp_closes end),0),0) as MAR1639F, 
    coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then yp_fee end)/nullif(sum(case when s.market_id = 26 and c.is_fence = 1 then yp_closes end),0),0) as MAR1687F, 
    coalesce(sum(case when s.market like '%-PA-%'  and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like '%-PA-%'  and c.is_fence = 1 then ms_closes end),0),0) as MAR1280F,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR1279F,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR1278F,
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL830F, 
    coalesce(sum(case when s.market like '%-PA-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like '%-PA-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL831F, -- bo_cpa_penn,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR1316F,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR1315F,
    coalesce(sum(case when s.market like '%-GA-%'  and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like '%-GA-%'  and c.is_fence = 1 then ms_closes end),0),0) as MAR1317F,
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL853F, 
    coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL854F, -- bo_cpa_ga,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL1088F, -- bo_cpa_pa_wa,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL1087F,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then ms_closes end),0),0) as MAR2297F, 
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR2296F,
    coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR2295F,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then bo_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then bo_closes end),0),0) as SAL1160F, -- bo_cpa_Illinois,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then fb_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then fb_closes end),0),0) as SAL1159F,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then ms_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then ms_closes end),0),0) as MAR2881F, 
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then yp_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then yp_closes end),0),0) as MAR2880F,
    coalesce(sum(case when s.market like 'WN-IL-%' and s.is_fence = 1 then gg_fee end)/nullif(sum(case when c.market like 'WN-IL-%' and c.is_fence = 1 then gg_closes end),0),0) as MAR2879F,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then bo_closes end),0),0) as SAL1182F, -- bo_cpa_wn_il,
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then gg_closes end),0),0) as MAR2938F, 
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then fb_closes end),0),0) as MAR2939F, 
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when s.market_id = 42 and c.is_fence = 1 then yp_closes end),0),0) as MAR2940F, 
    coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when s.market_id = 42 and c.is_fence = 1 then ms_closes end),0),0) as MAR2941F,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then bo_closes end),0),0) as SAL1205F, -- bo_cpa_wn_il,
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then gg_closes end),0),0) as MAR2997F, 
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then fb_closes end),0),0) as MAR2998F, 
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when s.market_id = 57 and c.is_fence = 1 then yp_closes end),0),0) as MAR2999F, 
    coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when s.market_id = 57 and c.is_fence = 1 then ms_closes end),0),0) as MAR3000F,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then bo_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then bo_closes end),0),0) as SAL1228F, -- bo_cpa_wn_il,
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then gg_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then gg_closes end),0),0) as MAR3056F, 
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then fb_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then fb_closes end),0),0) as MAR3057F, 
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then yp_fee end) / nullif(sum(case when s.market_id = 58 and c.is_fence = 1 then yp_closes end),0),0) as MAR3058F, 
    coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then ms_fee end) / nullif(sum(case when s.market_id = 58 and c.is_fence = 1 then ms_closes end),0),0) as MAR3059F,
    --Driveway--
    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then yp_closes end),0),0) as MAR663D, 
    coalesce(sum(case when s.old_region = 'North California' and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when c.old_region = 'North California' and c.is_driveway = 1 then ms_closes end),0),0) as MAR664D,
    coalesce(sum(case when s.market_id=2  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=2 and c.is_driveway = 1 then yp_closes end),0),0) as MAR459D, 
    coalesce(sum(case when s.market_id=2 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=2 and c.is_driveway = 1 then ms_closes end),0),0) as MAR464D,
    coalesce(sum(case when s.market_id in (4,30,31)  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id in (4,30,31) and c.is_driveway = 1 then yp_closes end),0),0) as MAR460D, 
    coalesce(sum(case when s.market_id in (4,30,31) and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id in (4,30,31) and c.is_driveway = 1 then ms_closes end),0),0) as MAR465D,
    coalesce(sum(case when s.market_id=9  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=9 and c.is_driveway = 1 then yp_closes end),0),0) as MAR461D, 
    coalesce(sum(case when s.market_id=9 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=9 and c.is_driveway = 1 then ms_closes end),0),0) as MAR466D,
    coalesce(sum(case when s.market_id= 3  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=3 and c.is_driveway = 1 then yp_closes end),0),0) as MAR462D, 
    coalesce(sum(case when s.market_id= 3 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=3 and c.is_driveway = 1 then ms_closes end),0),0) as MAR467D,
    coalesce(sum(case when s.market_id=10  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=10 and c.is_driveway = 1 then yp_closes end),0),0) as MAR463D, 
    coalesce(sum(case when s.market_id=10 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=10 and c.is_driveway = 1 then ms_closes end),0),0) as MAR468D,
    coalesce(sum(case when c.old_region = 'South California'  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.old_region = 'South California' and c.is_driveway = 1 then yp_closes end),0),0) as SAL380D, 
    coalesce(sum(case when c.old_region = 'South California' and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.old_region = 'South California' and c.is_driveway = 1 then ms_closes end),0),0) as SAL381D, 
    coalesce(sum(case when s.market_id=14  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=14 and c.is_driveway = 1 then yp_closes end),0),0) as SAL434D, 
    coalesce(sum(case when s.market_id=14 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=14 and c.is_driveway = 1 then ms_closes end),0),0) as SAL435D, 
    coalesce(sum(case when s.market_id=5  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=5 and c.is_driveway = 1 then yp_closes end),0),0) as SAL441D, 
    coalesce(sum(case when s.market_id=5 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=5 and c.is_driveway = 1 then ms_closes end),0),0) as SAL442D, 
    coalesce(sum(case when s.market_id=6  and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id=6 and c.is_driveway = 1 then yp_closes end),0),0) as SAL448D, 
    coalesce(sum(case when s.market_id=6 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id=6 and c.is_driveway = 1 then ms_closes end),0),0) as SAL449D, 
    coalesce(sum(case when s.market_id= 14 and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id= 14 and c.is_driveway = 1 then yp_closes end),0),0) as SAL533D, 
    coalesce(sum(case when s.market_id= 14 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id= 14 and c.is_driveway = 1 then ms_closes end),0),0) as SAL534D, 
    coalesce(sum(case when s.market_id= 1 and s.is_driveway = 1 then yp_fee end)/nullif(sum(case when s.market_id= 1 and c.is_driveway = 1 then yp_closes end),0),0) as SAL590D, 
    coalesce(sum(case when s.market_id= 1 and s.is_driveway = 1 then ms_fee end)/nullif(sum(case when s.market_id= 1 and c.is_driveway = 1 then ms_closes end),0),0) as SAL591D,

    coalesce(sum(case when s.old_region = 'North California' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.old_region = 'North California' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2427F, -- ha_ads_cpl_nc,
    coalesce(sum(case when s.market_id = 2 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 2 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2428F, -- ha_ads_cpl_eb,
    coalesce(sum(case when s.market_id = 8 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 8 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2503F, -- ha_ads_cpl_sf,
    coalesce(sum(case when s.market_id = 9 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 9 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2429F, -- ha_ads_cpl_nb,
    coalesce(sum(case when s.market_id = 3 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 3 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2430F, -- ha_ads_cpl_sac,
    coalesce(sum(case when s.market_id = 29 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 29 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2431F, -- ha_ads_cpl_st,
    coalesce(sum(case when s.market_id = 10 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 10 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2432F, -- ha_ads_cpl_fr,
    coalesce(sum(case when s.market_id = 4 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 4 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2433F, -- ha_ads_cpl_wa,
    coalesce(sum(case when s.market_id = 30 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 30 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2434F, -- ha_ads_cpl_sj,
    coalesce(sum(case when s.market_id = 31 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 31 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2435F, -- ha_ads_cpl_pa,
    coalesce(sum(case when s.old_region = 'South California' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.old_region = 'South California' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2436F, -- ha_ads_cpl_sc,
        coalesce(sum(case when s.market_id = 14 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 14 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2437F, -- ha_ads_sv_cpl,
        coalesce(sum(case when s.market_id = 5 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 5 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2438F, -- ha_ads_oc_cpl,
        coalesce(sum(case when s.market_id = 6 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 6 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2439F, -- ha_ads_la_cpl,
        coalesce(sum(case when s.market_id = 7 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 7 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2440F, -- ha_ads_vc_cpl,
        coalesce(sum(case when s.market_id = 1 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 1 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2441F, -- ha_ads_sd_cpl,
        coalesce(sum(case when s.market like '%-TX-%' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market like '%-TX-%' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2442F, -- ha_ads_tx_cpl,
        coalesce(sum(case when s.market_id = 16 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 16 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2443F, -- ha_ads_cpl_dl,
        coalesce(sum(case when s.market_id = 17 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 17 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2444F, -- ha_ads_cpl_fw,
        coalesce(sum(case when s.market_id = 18 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 18 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2445F, -- ha_ads_cpl_ht,
        coalesce(sum(case when s.market_id = 19 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 19 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2446F, -- ha_ads_cpl_sa,
        coalesce(sum(case when s.market_id = 32 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 32 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2447F, -- ha_ads_cpl_au,
        coalesce(sum(case when s.market like '%-GA-%' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market like '%-GA-%' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2448F, -- ha_ads_ga_cpl,
        coalesce(sum(case when s.market_id = 20 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 20 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2449F, -- ha_ads_cpl_at,
        coalesce(sum(case when s.old_region in ('Maryland','Pennsylvania','Virginia') and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.old_region in ('Maryland','Pennsylvania','Virginia') and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2450F, -- ha_ads_cpl_ne,
        coalesce(sum(case when s.market_id = 22 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 22 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2451F, -- ha_ads_cpl_bl,
        coalesce(sum(case when s.market_id = 21 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 21 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2452F, -- ha_ads_cpl_dc,
        coalesce(sum(case when s.market_id = 33 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 33 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2453F, -- ha_ads_cpl_ph,
        coalesce(sum(case when s.market_id = 35 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 35 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2454F, -- ha_ads_cpl_ar,
        coalesce(sum(case when s.market like '%-FL-%' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market like '%-FL-%' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2455F, -- ha_ads_fl_cpl,
        coalesce(sum(case when s.market_id = 24 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 24 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2456F, -- ha_ads_cpl_mi,
        coalesce(sum(case when s.market_id = 26 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 26 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2457F, -- ha_ads_cpl_or,
        coalesce(sum(case when s.market like 'PA-WA-%' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market like 'PA-WA-%' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2463F, -- ha_ads_cpl_pa_wa,
        coalesce(sum(case when s.market_id = 43 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 43 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2464F, -- ha_ads_cpl_se,
        coalesce(sum(case when s.market like 'WN-IL%' and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market like 'WN-IL%' and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2525F, -- ha_ads_cpl_wn_il,
        coalesce(sum(case when s.market_id = 42 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 42 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2910F, -- ha_ads_cpl_wn_il,
        coalesce(sum(case when s.market_id = 57 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 57 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR2969F, -- ha_ads_cpl_wn_il,
        coalesce(sum(case when s.market_id = 58 and s.is_fence = 1 then ha_ads_fee end) / nullif(sum(case when c.market_id = 58 and c.is_fence = 1 then ha_ads_closes end),0),0) as MAR3028F -- ha_ads_cpl_wn_il,
    from timeseries f
    left join spend s on s.lead_arrived_at = f.date
    left join final_closes c on c.close_date = f.date
                             and s.market = c.market
                             and s.old_region = c.old_region
                             and s.market_id = c.market_id
                             and s.region = c.region
                             and s.is_fence = c.is_fence
                             and s.is_commercial = c.is_commercial
                             and s.is_turf = c.is_turf
                             and s.is_driveway = c.is_driveway
    where s.is_commercial=0 and c.is_commercial=0
    group by 1
    )
    select c.*, cx.*except(date) 
    from cpa c
    left join comex cx using(date)
